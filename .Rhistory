timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "\\[|\\]"))
View(timeseries)
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "\[|\]"))
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "\\["))
parkmoves$visits_by_day[1]
timeseries$visits_by_day[1]
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = c("\\[","\\]")))
timeseries$visits_by_day[1]
timeseries$visits_by_day[1]
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = c("\\[","\\]")))
timeseries$visits_by_day[1]
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "\\[|\\]"))
timeseries$visits_by_day[1]
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]"))
timeseries$visits_by_day[1]
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ","))
timeseries$visits_by_day[1]
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = 1:n(),
visits = value)
})) %>%
unnest(cols = c(visits_by_day))
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble()}))
View(timeseries[[4]][[1]])
View(timeseries[[4]][[2]])
1:n()
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) }))
%>%
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = 1:n(),
visits = value)
})) %>%
unnest(cols = c(visits_by_day))
View(parkmoves)
unlist(x) %>%
as_tibble() %>%
mutate(day = n(),
visits = value)
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = n(),
visits = value)
})) %>%
unnest(cols = c(visits_by_day))
1:10
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = 1:n(),
visits = value)
}))
View(timeseries[[4]][[1]])
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = 1:n(),
visits = value)
})) %>%
unnest(cols = c(visits_by_day))
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = 1:n(),
visits = value)
})) %>%
unnest(cols = c(visits_by_day)) %>%
dplyr::select(-value)
tictoc::tic()
View(nightmoves)
tictoc::tic()
#tictoc::tic()
timeseries <-
parkmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = 1:n(),
visits = value)
})) %>%
unnest(cols = c(visits_by_day)) %>%
dplyr::select(-value)
tictoc::toc()
rm(nightmoves)
rm(possible_businesses)
odMatrix <-
parkmoves %>%
select(safegraph_place_id, visitor_home_cbgs) %>%
mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
jsonlite::fromJSON(x) %>%
as_tibble()
})) %>%
unnest(visitor_home_cbgs) %>%
pivot_longer(!safegraph_place_id, names_to = "cbg", values_to = "visits")
View(odMatrix)
odMatrix <-
parkmoves %>%
select(safegraph_place_id, visitor_home_cbgs) %>%
mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
jsonlite::fromJSON(x) %>%
as_tibble()
}))
View(odMatrix[[2]][[1]])
fromJSON(I(toJSON(1:10)))
jsonlite::fromJSON(I(toJSON(1:10)))
odMatrix <-
parkmoves %>%
select(safegraph_place_id, visitor_home_cbgs) %>%
mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
jsonlite::fromJSON(x) %>%
as_tibble()
})) %>%
unnest(visitor_home_cbgs)
odMatrix <-
parkmoves %>%
select(safegraph_place_id, visitor_home_cbgs) %>%
mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
jsonlite::fromJSON(x) %>%
as_tibble()
})) %>%
unnest(visitor_home_cbgs) %>%
pivot_longer(!safegraph_place_id, names_to = "cbg", values_to = "visits") %>%
drop_na(visits)
gc()
test <- odMatrix %>%
mutate(row_number = row_number())
View(test)
test <- odMatrix %>%
mutate(row_number = row_number()) %>%
group_by(cbg) %>% summarize(fake_distance = mean(row_number))
test <- odMatrix %>%
mutate(row_number = row_number()) %>%
group_by(cbg) %>% summarize(fake_distance = mean(row_number)) %>%
ungroup()
test <- odMatrix %>%
mutate(row_number = row_number()) %>%
group_by(cbg) %>% summarize(fake_distance = mean(row_number)
test <- odMatrix %>%
test <- odMatrix %>%
mutate(row_number = row_number()) %>%
group_by(cbg) %>% summarize(fake_distance = mean(row_number))
test <- odMatrix %>%
mutate(row_number = row_number()) %>%
group_by(cbg) %>% summarize(fake_distance = mean(row_number)) %>%
ungroup()
test <- odMatrix %>%
mutate(row_number = row_number()) %>%
group_by(cbg) %>% summarize(fake_distance = mean(row_number)) %>%
ungroup() %>%
left_join(odMatrix, .)
test <- odMatrix %>%
mutate(row_number = row_number()) %>%
group_by(cbg) %>% summarize(fake_distance = mean(row_number)) %>%
ungroup() %>%
left_join(odMatrix, .) %>%
left_join(., parkmoves)
source("https://raw.githubusercontent.com/alexsingleton/Huff-Tools/master/huff-tools.r")
install.packages("rgeos")
source("https://raw.githubusercontent.com/alexsingleton/Huff-Tools/master/huff-tools.r")
library(rgeos)
source("https://raw.githubusercontent.com/alexsingleton/Huff-Tools/master/huff-tools.r")
library(igraph)
install.packages("igraph")
library(igraph)
source("https://raw.githubusercontent.com/alexsingleton/Huff-Tools/master/huff-tools.r")
install.packages("fastshp")
source("https://raw.githubusercontent.com/alexsingleton/Huff-Tools/master/huff-tools.r")
library(fastshp)
install.packages("fastshp")
install.packages("fastshp",,"http://rforge.net/",type="source")
library(fastshp)
source("https://raw.githubusercontent.com/alexsingleton/Huff-Tools/master/huff-tools.r")
huff_results <- huff_basic(test$location_name, test$raw_visit_counts, test$cbg, test$fake_distance)
View(parks)
ggplot()+
geom_point(data = parkmoves %>%
left_join(parks, by = c("safegraph_place_id")),
aes(y = latitude, x = longitude, color = raw_visitor_counts,
fill = raw_visitor_counts, size = raw_visitor_counts),
alpha = 0.5)
ggplot(parkmoves %>%
filter(location_name %in% c("Clark Park", "Strawberry Mansion Playground",
"Cherashore Playground", "Shot Tower Playground",
"Mander Playground", "Schuylkill River Park",
"Penn Treaty Park", "Jose Manuel Collazo Playground",
"Wissahickon Valley Park", "Weccacoe Playground")))+
geom_line(aes(x = date_range_start, y = raw_visit_counts))+
facet_wrap(~location_name, scales = "free")
ggplot(parkmoves)+
geom_point(aes(x = date_range_start, y = raw_visit_counts))
parkspoly <- st_read("https://opendata.arcgis.com/datasets/d52445160ab14380a673e5849203eb64_0.geojson") %>%
st_transform(4326)
ggplot()+geom_sf(data=parkspoly)
#ggplot()+geom_sf(data=parkspoly)
parks_and_polygon <- st_join(parks %>% st_transform(crs = 4326), parkspoly)
ggplot()+
geom_sf(data = parkspoly, fill = "light green", alpha = 0.4)+
geom_point(data = parks_and_polygon %>%
mutate(joins_municipal = ifelse(is.na(PARENT_NAME) == TRUE,
"No join", "Join")),
aes(y = latitude, x = longitude, color = joins_municipal))
ggplot()+
geom_sf(data = st_union(parkspoly), fill = "light green", alpha = 0.4)+
geom_point(data = parks_and_polygon %>%
filter(is.na(PARENT_NAME) == FALSE),
aes(y = latitude, x = longitude), size = 0.5)
mapView(parks, alpha = 0.6, size = 0.5) + mapView(parkspoly, col.regions = "green")
knitr::opts_chunk$set(echo = TRUE)
#HPS = home_panel_summary
#NS = normalization_stats
#VPS = visit_panel_summary
monthList = c("01","02","03","04","05","06","07","08","09","10","11")
# home_panel_summary
hpsAllMonth = data.frame()
for (i in monthList){
currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
i,
"-2021-12-17/home_panel_summary.csv",sep = ""))%>%
filter(region=="pa")
hpsAllMonth = rbind(hpsAllMonth,currentMonth)
#print(paste("Current input home_panel_summary dataframe is in ",i," month",sep = ""))
}
kable(head(hpsAllMonth,3),align = 'c',caption = '<center>Table 3. home pannel summary of 2021 whole year in SafeGraph data <center/>')%>%
kable_classic(full_width = F)%>%
kable_styling(position = "center")%>%
scroll_box(width = "100%", height = "400px")
# normalization_Stats
nsAllMonth = data.frame()
for (i in monthList){
currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
i,
"-2021-12-17/normalization_stats.csv",sep = ""))%>%
filter(region=="pa")
nsAllMonth = rbind(nsAllMonth,currentMonth)
#print(paste("Current input normalization_stats dataframe is in ",i," month",sep = ""))
}
kable(head(nsAllMonth,3),align = 'c',caption = '<center>Table 4. normalization stats of 2021 whole year in SafeGraph data <center/>')%>%
kable_classic(full_width = F)%>%
kable_styling(position = "center")%>%
scroll_box(width = "100%", height = "400px")
# visit_panel_summary
vpsAllMonth = data.frame()
for (i in monthList){
currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
i,
"-2021-12-17/visit_panel_summary.csv",sep = ""))%>%
filter(region=="pa")
vpsAllMonth = rbind(vpsAllMonth,currentMonth)
#print(paste("Current input visit_panel_summary dataframe is in ",i," month",sep = ""))
}
kable(head(vpsAllMonth,3),align = 'c',caption = '<center>Table 5. visit panel summary of 2021 whole year in SafeGraph data <center/>')%>%
kable_classic(full_width = F)%>%
kable_styling(position = "center")%>%
scroll_box(width = "100%", height = "400px")
# Pattern
patternAllMonth = data.frame()
for (i in monthList){
currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
i,
"-2021-12-17/patterns.csv.gz",sep = ""))%>%
filter(region=="PA")%>%
mutate(month=paste(i,sep = ""))
patternAllMonth = rbind(patternAllMonth,currentMonth)
#print(paste("Current input patterns dataframe is in ",i," month",sep = ""))
}
kable(head(patternAllMonth,3),align = 'c',caption = '<center>Table 6. patterns of 2021 whole year in SafeGraph data <center/>')%>%
kable_classic(full_width = F)%>%
kable_styling(position = "center")%>%
scroll_box(width = "100%", height = "400px")
# filter into philly
safeGraph <- patternAllMonth %>%
filter(city == "Philadelphia")
View(safeGraph)
core_poi <- vroom("data/safegraph/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-CORE_POI-2021_11-2021-12-17/core_poi.csv")
brand_info <- vroom("data/safegraph/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-CORE_POI-2021_11-2021-12-17/brand_info.csv")
View(core_poi)
safeGraph <- safeGraph %>%
left_join(core_poi, by=c("placekey","parent_placekey","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands"),keep=FALSE)
# filter into philly
safeGraph <- patternAllMonth %>%
filter(city == "Philadelphia")
safeGraph <- safeGraph %>%
left_join(core_poi, by=c("placekey"),keep=FALSE)
# filter into philly
safeGraph <- patternAllMonth %>%
filter(city == "Philadelphia")
safeGraph <- safeGraph %>%
left_join(core_poi, by=c("placekey","parent_placekey","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands"),keep=FALSE)
safeGraph <- safeGraph %>%
left_join(core_poi, by=c("placekey"),keep=FALSE)
# filter into philly
safeGraph <- patternAllMonth %>%
filter(city == "Philadelphia")
safeGraph <- safeGraph %>%
left_join(core_poi, by=c("placekey","parent_placekey","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands"),keep=FALSE)
# filter into philly
safeGraph <- patternAllMonth %>%
filter(city == "Philadelphia")
safeGraph <- safeGraph %>%
left_join(core_poi, by=c("placekey"),keep=FALSE)
# filter into philly
safeGraph <- patternAllMonth %>%
filter(city == "Philadelphia")
# join with POI and brand data
safeGraph <- safeGraph %>%
left_join(core_poi, by=c("placekey","parent_placekey","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands"),keep=FALSE) %>%
left_join(brand_info, by=c("safegraph_brand_ids"="safegraph_brand_id","brands"="brand_name","top_category","sub_category","naics_code"),keep=FALSE)
# create geometry from lat & lng
safeGraph.geo <-
safeGraph %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant", na.fail=FALSE)
safeGraph.geo <-
safeGraph %>%
st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant", na.fail=FALSE)
unique(is.na(safeGraph.geo$geometry))
library(furrr)
numCores <- availableCores() - 1
plan(multiprocess, workers = numCores)
## Keep only parks
parks <- safeGraph %>%
filter( naics_code %in% c(712190, 713990))
PPRmoves <- safeGraph %>%
filter(placekey %in% as.list(parks$placekey))
View(PPRmoves)
timeseries <-
PPRmoves %>%
select(safegraph_place_id, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = 1:n(),
visits = value)
})) %>%
unnest(cols = c(visits_by_day)) %>%
dplyr::select(-value)
timeseries <-
PPRmoves %>%
select(placekey, date_range_start, date_range_end, visits_by_day) %>%
mutate(date_range_start = as_date(date_range_start),
date_range_end = as_date(date_range_end)) %>%
mutate(visits_by_day = str_remove_all(visits_by_day, pattern = "[\\[\\]]")) %>%
mutate(visits_by_day = str_split(visits_by_day, pattern = ",")) %>%
mutate(visits_by_day = future_map(visits_by_day, function(x){
unlist(x) %>%
as_tibble() %>%
mutate(day = 1:n(),
visits = value)
})) %>%
unnest(cols = c(visits_by_day)) %>%
dplyr::select(-value)
View(timeseries)
odMatrix <-
PPRmoves %>%
select(placekey, visitor_home_cbgs) %>%
mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
jsonlite::fromJSON(x) %>%
as_tibble()
})) %>%
unnest(visitor_home_cbgs) %>%
pivot_longer(!safegraph_place_id, names_to = "cbg", values_to = "visits") %>%
drop_na(visits)
odMatrix <-
PPRmoves %>%
select(placekey, visitor_home_cbgs) %>%
mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
jsonlite::fromJSON(x) %>%
as_tibble()
})) %>%
unnest(visitor_home_cbgs) %>%
pivot_longer(!placekey, names_to = "cbg", values_to = "visits") %>%
drop_na(visits)
gc()
gc()
gc()
numCores <- availableCores() - 3
plan(multiprocess, workers = numCores)
gc()
rm(odMatrix)
rm(huff_results)
gc()
View(core_poi)
View(PPRmoves)
write.csv(PPRmoves,"data/safegraph/PPRmoves.csv")
PPRmoves <- st_read("data/safegraph/PPRmoves.csv")
View(parkmoves)
PPRmoves <- st_read("data/safegraph/PPRmoves.csv")
gc()
numCores <- availableCores() - 6
plan(multiprocess, workers = numCores)
odMatrix <-
PPRmoves %>%
select(placekey, visitor_home_cbgs) %>%
mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
jsonlite::fromJSON(x) %>%
as_tibble()
})) %>%
unnest(visitor_home_cbgs) %>%
pivot_longer(!placekey, names_to = "cbg", values_to = "visits") %>%
drop_na(visits)
