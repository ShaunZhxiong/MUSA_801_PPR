---
title: "PPPR"
author: "PPPR Team"
output:
  html_document: 
    toc: yes
    toc_depth: 4
    toc_float: yes
    code_folding: hide
    theme: paper
  pdf_document: default
---

```{=html}
<style>
p.caption {
  font-size: 0.8em;
  text-align: center;
  font-weight: normal;
}
    caption {
      color: grey;
      font-size: 0.8em;
    }
@font-face{
  font-family: Helvetica; 
  src:url('Helvetica.ttf');
}
body{
  font-size: 11pt;
  font-family: Helvetica;
}
h1,h2,h3,h4,h5,h6{
  font-family: Helvetica;
  color: red;
}
td{
  font-size: 9pt;
  font-family: Helvetica;
}
th{
  font-size: 0.8em;
  font-family: Helvetica;
  color: black;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, message=FALSE, warning=FALSE, results='hide'}
library(vroom)
library(sf)
library(ggplot2)
library(ggmap)
library(kableExtra)
library(tidyverse)
library(data.table)
#remotes::install_github("CityOfPhiladelphia/rphl")
library(rphl)
library(lubridate)
library(furrr)
library(tidycensus)

ll <- function(dat, proj4 = 4326){st_transform(dat, proj4)}

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

#windowsFonts(font = windowsFont('Helvetica'))

crs = 'EPSG:2272'

plotTheme <- function(base_size = 9, title_size = 10){
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = title_size, colour = "black", hjust = 0.5), 
    plot.subtitle = element_text( face = 'italic',
                                 size = base_size, colour = "black", hjust = 0.5),
    plot.caption = element_text( hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.01),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=.5),
    strip.background = element_blank(),
    strip.text = element_text( size=9),
    axis.title = element_text( size=9),
    axis.text = element_text( size=7),
    axis.text.y = element_text( size=7),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text( colour = "black", face = "italic", size = 9),
    legend.text = element_text( colour = "black", face = "italic", size = 7),
    strip.text.x = element_text( size = 9),
    legend.key.size = unit(.5, 'line')
  )
}

mapTheme <- function(base_size = 9, title_size = 10){
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = title_size, colour = "black", hjust = 0.5), 
    plot.subtitle = element_text( face = 'italic',
                                 size = base_size, colour = "black", hjust = 0.5),
    plot.caption = element_text( hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size=base_size),
    axis.title = element_text( size=9),
    axis.text = element_blank(),
    axis.text.y = element_blank(),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text( colour = "black", face = "italic", size = 9),
    legend.text = element_text( colour = "black", face = "italic", size = 7),
    strip.text.x = element_text(size=base_size),
    legend.key.size = unit(.5, 'line')
  )
}

palette5 <- c("#f9b294","#f2727f","#c06c86","#6d5c7e","#315d7f")
palette4 <- c("#f9b294","#f2727f","#c06c86","#6d5c7e")
palette2 <- c("#f9b294","#f2727f")
palette1_main <- "#F2727F"
palette1_assist <- '#F9B294'
```


```{r loadSecrets}

## NOTE: You will need to create secrets.json, using the template
## to enter private credentials for interacting with the database

get_secrets <- function() {
  path <- "secrets/secrets.json"
  if (!file.exists(path)) {
    stop("Can't find secret file: '", path, "'")
  }
  
  jsonlite::read_json(path)
}
secrets <- get_secrets()

# database settings
dbname = secrets$db_name
host = secrets$db_host
port = secrets$db_port
username =  secrets$db_username
password = secrets$db_password
census_api_key(secrets$census_api_key, install=TRUE, overwrite=TRUE)
```

### Data Loading

#### Folder: OneDrive-2021-12-07

```{r moves2018, warning=FALSE, message=FALSE}
# moves2018 <- vroom("data/OneDrive-2021-12-07/moves_2018.csv")
# colnames(moves2018)
```

```{r moves2020, message=FALSE, warning=FALSE}
# moves_monthly2020 <- vroom("data/OneDrive-2021-12-07/moves_monthly2020.csv")
# colnames(moves_monthly2020)
```

The above two data are from 2018 and 2020. Based on the SOP, we only used the data of 2021. **Therefore, these two files should not be used.**

#### Folder: safegraph

```{r brand_info, message=FALSE, warning=FALSE}
brand_info <- vroom("data/safegraph/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-CORE_POI-2021_11-2021-12-17/brand_info.csv")
#colnames(brand_info)

kable(head(brand_info,3),align = 'c',caption = '<center>Table 1. brand_info of SafeGraph data <center/>')%>%
  kable_classic(full_width = F)%>%
  kable_styling(position = "center")%>% 
  scroll_box(width = "100%", height = "400px")
```

```{r core_poi, message=FALSE, warning=FALSE}
core_poi <- vroom("data/safegraph/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-CORE_POI-2021_11-2021-12-17/core_poi.csv")
#colnames(core_poi)

kable(head(core_poi,3),align = 'c',caption = '<center>Table 2. core_poi of SafeGraph data <center/>')%>%
  kable_classic(full_width = F)%>%
  kable_styling(position = "center")%>% 
  scroll_box(width = "100%", height = "400px")
```

**These two datasets ('brand_info' and 'core_poi' from safegraph) are dictionary data.**

```{r wholeRawSG, message=FALSE, warning=FALSE}
#HPS = home_panel_summary
#NS = normalization_stats
#VPS = visit_panel_summary

monthList = c("01","02","03","04","05","06","07","08","09","10","11")

# home_panel_summary
hpsAllMonth = data.frame()

for (i in monthList){
  currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
       i,
       "-2021-12-17/home_panel_summary.csv",sep = ""))%>%
    filter(region=="pa")
  hpsAllMonth = rbind(hpsAllMonth,currentMonth)
  #print(paste("Current input home_panel_summary dataframe is in ",i," month",sep = ""))
}

kable(head(hpsAllMonth,3),align = 'c',caption = '<center>Table 3. home pannel summary of 2021 whole year in SafeGraph data <center/>')%>%
  kable_classic(full_width = F)%>%
  kable_styling(position = "center")%>% 
  scroll_box(width = "100%", height = "400px")

# normalization_Stats
nsAllMonth = data.frame()

for (i in monthList){
  currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
       i,
       "-2021-12-17/normalization_stats.csv",sep = ""))%>%
    filter(region=="pa")
  nsAllMonth = rbind(nsAllMonth,currentMonth)
  #print(paste("Current input normalization_stats dataframe is in ",i," month",sep = ""))
}

kable(head(nsAllMonth,3),align = 'c',caption = '<center>Table 4. normalization stats of 2021 whole year in SafeGraph data <center/>')%>%
  kable_classic(full_width = F)%>%
  kable_styling(position = "center")%>% 
  scroll_box(width = "100%", height = "400px")

# visit_panel_summary
vpsAllMonth = data.frame()

for (i in monthList){
  currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
       i,
       "-2021-12-17/visit_panel_summary.csv",sep = ""))%>%
    filter(region=="pa")
  vpsAllMonth = rbind(vpsAllMonth,currentMonth)
  #print(paste("Current input visit_panel_summary dataframe is in ",i," month",sep = ""))
}

kable(head(vpsAllMonth,3),align = 'c',caption = '<center>Table 5. visit panel summary of 2021 whole year in SafeGraph data <center/>')%>%
  kable_classic(full_width = F)%>%
  kable_styling(position = "center")%>% 
  scroll_box(width = "100%", height = "400px")

# Pattern
patternAllMonth = data.frame()

for (i in monthList){
  currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
       i,
       "-2021-12-17/patterns.csv.gz",sep = ""))%>%
    filter(region=="PA")%>%
    mutate(month=paste(i,sep = ""))
  patternAllMonth = rbind(patternAllMonth,currentMonth)
  #print(paste("Current input patterns dataframe is in ",i," month",sep = ""))
}

kable(head(patternAllMonth,3),align = 'c',caption = '<center>Table 6. patterns of 2021 whole year in SafeGraph data <center/>')%>%
  kable_classic(full_width = F)%>%
  kable_styling(position = "center")%>% 
  scroll_box(width = "100%", height = "400px")
```

**This is the whole safegraph raw data**, it has four datasets. One is the aggregated pattern data for 2021 whole year. That is the primary one for this project. And the other two datasets give information about the number of active devices.

#### Folder: OpenDataPhilly

**Relevant data of PPR finder**

```{r openDataPhilly_pprDistrict,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 1. Locations of pprDistrict'}
philly <- st_read("https://opendata.arcgis.com/datasets/405ec3da942d4e20869d4e1449a2be48_0.geojson")

pprDistrict <- st_read('https://opendata.arcgis.com/datasets/0cdc4a1e86c6463b9600f9d9fca39875_0.geojson') %>%
  st_transform(crs)

destDistrict <- pprDistrict %>% filter(DISTRICTID %in% c(7,8,9))

base_map <- get_map(location = unname(st_bbox(ll(st_buffer(st_union(pprDistrict),11000)))),maptype = "terrian")

ggmap(base_map) + 
  geom_sf(data=ll(st_union(pprDistrict)),color="black",size=2,fill = "transparent",inherit.aes = FALSE)+
  geom_sf(data=ll(pprDistrict),color='black',size=2,fill = "transparent",inherit.aes = FALSE)+
  geom_sf(data=ll(destDistrict),color=palette1_main,size=2,fill = "transparent",inherit.aes = FALSE)+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```

The whole Philadelphia is divided into 10 PPR districts, and the project mainly focus on the District 7、8、9 as pilot project which are highlighted in the map using the color red.

```{r openDataPhilly_pprProperty,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 2. Locations of pprProperties'}
pprProperties <- st_read('https://opendata.arcgis.com/datasets/d52445160ab14380a673e5849203eb64_0.geojson')%>%
  st_transform(crs)

ggplot() + 
  geom_sf(data=pprProperties,color=palette1_main,fill = palette1_main)+
  geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
  geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```

```{r openDataPhilly_pprTrail, eval=FALSE, fig.align='center', fig.cap=, fig.height=5, message=FALSE, warning=FALSE, include=FALSE, out.width='75%', results='hide'}
pprTrails <- st_read('https://opendata.arcgis.com/datasets/48323d574068405bbf5336b9b5b29455_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprTrails,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_Out of school time programs, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 4. Out of school time programs'}
pprOutPrograms <- st_read('https://opendata.arcgis.com/datasets/1f5d8108e06d457783538d4b7808c246_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprOutPrograms,color=palette1_main,size=8,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprPicnicSites, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 5. Locations of pprPicnicSites'}
pprPicnicSites <- st_read('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+ppr_picnic_sites&filename=ppr_picnic_sites&format=geojson&skipfields=cartodb_id')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprPicnicSites,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprAdultExercise, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 6. Locations of pprAdultExercise'}
pprAdExercise <- st_read('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+ppr_adult_exercise_equipment&filename=ppr_adult_exercise_equipment&format=geojson&skipfields=cartodb_id')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprAdExercise,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprSwimmingPool, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 7. Locations of pprSwimmingPool'}
pprSwimmingPool <- st_read('https://opendata.arcgis.com/datasets/c6f6176968f04d3f88adbc4c362af55d_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprSwimmingPool,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprTennisCourt, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 8. Locations of pprTennisCourt'}
pprTennisCourt <- st_read('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+ppr_tennis_courts&filename=ppr_tennis_courts&format=geojson&skipfields=cartodb_id')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprTennisCourt,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprSpraygrounds, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 9. Locations of pprSpraygrounds'}
pprSpraygrounds <- st_read('https://opendata.arcgis.com/datasets/a148cc904d374b22bd456e44a044d554_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprSpraygrounds,color=palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprHydrationStations, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 10. Locations of pprHydrationStations'}
pprHydrationStations <- st_read('https://opendata.arcgis.com/datasets/cc35dc98180249fb9a6f2f5f06657df1_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprHydrationStations,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprPlaygrounds, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 11. Locations of pprPlaygrounds'}
pprPlaygrounds <- st_read('https://opendata.arcgis.com/datasets/899c807e205244278b3f39421be8489c_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprPlaygrounds,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprBoatLaunches, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 12. Locations of pprBoatLaunches'}
pprBoatLaunches <- st_read('https://opendata.arcgis.com/api/v3/datasets/ba32e1ac9c5341e1916274c2df3fbe22_0/downloads/data?format=geojson&spatialRefId=4326')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprBoatLaunches,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprBuildingStructures, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 13. Locations of pprBuildingStructures'}
pprBuildingStructures <- st_read('https://opendata.arcgis.com/datasets/97e90a049a35453ba0c51f974b3c77b4_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprBuildingStructures,color=palette1_main,size=1,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprTreeCanopy, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 14. Locations of pprTreeCanopy'}
query <- paste("SELECT objectid, avg_height, shape_area",
               "FROM ppr_tree_canopy_outlines_2015",
               "ORDER BY objectid ASC")

pprTreeCanopyWithArea <- get_carto(query, format = "csv",
  base_url = "https://phl.carto.com/api/v2/sql", stringsAsFactors = F)


pprTreeCanopy <- st_read('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+ppr_tree_canopy_points_2015&filename=ppr_tree_canopy_points_2015&format=geojson&skipfields=cartodb_id')%>%
  st_transform(crs)%>%
  left_join(pprTreeCanopyWithArea,by = "objectid")

# ggplot() + 
#   geom_sf(data=pprTreeCanopy,color=palette1_main,aes(size=shape_area),fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprPermittableSpace, eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 15. Locations of pprPermittableSpace'}
pprPermittableSpace <- st_read('https://opendata.arcgis.com/datasets/811b67c999bd4e839abb68b16c16f623_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprPermittableSpace,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

And there are other datasets from the PPR finder unused right now. They are datasets about the number and quality of facilities of PPR.

#### Folder: FromPPR

These are datasets directly from PPR officers. These datasets are highly related to our project.

```{r fromPPR_ServiceArea,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width ='75%',fig.align = 'center',fig.cap = 'Figure 15. Locations of pprServiceArea'}
library(rgdal)
pprServiceArea <- read_sf(dsn="data/FromPPR/PPR_Service_Areas_2021/PPR_Service_Areas_2021.shp")%>%
  st_transform(crs = crs)

pprDestServiceArea <- pprServiceArea %>% filter(PPR_DIST %in% c(7,8,9))

ggplot() + 
  geom_sf(data=pprServiceArea,color='black',size=1,fill = "transparent")+
  geom_sf(data=pprDestServiceArea,color=palette1_main,size=2,fill = "transparent")+
  geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```

The above map is about service areas. Each district unit is divided into several service area units for the sake of administration. The pink lines in the map are the services areas in District 7,8,9. These service areas are the target of this project. About the navy yard, whether it should be included into district 9?

```{r fromPPR-recreation-permits-2021, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
perimit2021 <- vroom("data/FromPPR/PPR-recreation-permits-2021.csv")
# kable(head(perimit2021,3),align = 'c',caption = '<center>Table 7. Program information of PPR Recreation data <center/>')%>%
#   kable_classic(full_width = F)%>%
#   kable_styling(position = "center")%>% 
#   scroll_box(width = "100%", height = "400px")
```

```{r fromPPR-programs-attended-2021, warning=FALSE, message=FALSE}
program2021 <- vroom("data/FromPPR/PPR-programs-attended-2021-with-schedules.csv")
kable(head(program2021,3),align = 'c',caption = '<center>Table 8. Program information of PPR Programs data <center/>')%>%
  kable_classic(full_width = F)%>%
  kable_styling(position = "center")%>% 
  scroll_box(width = "100%", height = "400px")
```

The above dataset gives information about PPR programs in 2021, including information like the duration of the program, the attendence of the program etc. But some wrangling are needed for further uses. And the wrangling is taken in the next section.

```{r from Service_Area_Sites}

propertyArea <- read.csv("data/FromPPR/Service_Area_Sites.csv") 
```

The above dataset has information about each property inside the service area. This dataset can be joined to **pprServiceArea** using the service area id.

```{r from tblFacility_to_PPR_Properties}
facilityID <- read.csv("data/FromPPR/tblFacility_to_PPR_Properties.csv")
```

The above dataset is offered as dictionary data to provide links between facility id and PPR property object id. ({003695FA-5CC6-4572-9916-799609577319} - 209)

### Data Wrangling

#### Property data

```{r join property data}
# replace "and" with "&"
pprProperties <- pprProperties %>% 
  mutate(OFFICIAL_NAME = gsub("and", "&", pprProperties$OFFICIAL_NAME),
         PUBLIC_NAME = gsub("and", "&", pprProperties$PUBLIC_NAME))


# join method 1
property.join1 <- left_join(propertyArea, 
                          pprProperties %>% dplyr::select(ADDRESS_911, geometry), 
                          by=c("X911.Address"="ADDRESS_911"), left=FALSE) %>% 
  filter(!st_is_empty(geometry))

# join method 2
property.join2 <- left_join(propertyArea, 
                          pprProperties %>% dplyr::select(OFFICIAL_NAME, geometry), 
                          by=c("PPR.Site.Name"="OFFICIAL_NAME"), left=FALSE) %>% 
  filter(!st_is_empty(geometry))

# join method 3
property.join3 <- left_join(propertyArea, 
                          pprProperties %>% dplyr::select(PUBLIC_NAME, geometry), 
                          by=c("PPR.Site.Name"="PUBLIC_NAME"), left=FALSE) %>% 
  filter(!st_is_empty(geometry))

# combine 3 methods together
property <- rbind(property.join1,property.join2) %>% 
  rbind(property.join3,.) %>% 
  distinct() %>% 
  st_sf()

x <- left_join(propertyArea, property, by="PPR.Site.Name") %>% 
  filter(st_is_empty(geometry))

```

```{r properties in the service area,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure. Locations of properties in District 7,8,9'}
# map the location of properties in district 7,8,9
ggplot() + 
  geom_sf(data=property %>% filter(Service.Area.PPR.District %in% c(7,8,9)),color=palette1_main,fill = palette1_main)+
  geom_sf(data=st_union(pprDestServiceArea %>% filter(PPR_DIST ==7)),color="black",size=2,fill = "transparent")+
  geom_sf(data=st_union(pprDestServiceArea %>% filter(PPR_DIST ==8)),color="black",size=2,fill = "transparent")+
  geom_sf(data=st_union(pprDestServiceArea %>% filter(PPR_DIST ==9)),color="black",size=2,fill = "transparent")+
  geom_sf(data=pprDestServiceArea,color="black",size=0.75,linetype ="dashed",fill = "transparent")+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```

Through above wrangling, we obtain the newest data about property and link them with service areas. The map only map the properties in the district 7/8/9

#### Program data

```{r wrangle program data}
# define date 
program2021.clean <- program2021 %>% 
  mutate(AttendanceWeekDate = mdy(AttendanceWeekDate),
         DateFrom = mdy(DateFrom),
         DateTo = mdy(DateTo))

# create a df only containing records without program scheduel info
program2021.NA <- program2021.clean[is.na(program2021.clean$ProgramScheduleID),]

# filter by attendance date
program2021.clean <- program2021.clean %>% 
  filter(AttendanceWeekDate > DateFrom & AttendanceWeekDate < DateTo)

# original data is recorded by week, here we change it into being recorded by occurence
program2021.clean <- separate(program2021.clean, Days,into= c("1","2","3","4","5","6","7"))

program2021.clean <- program2021.clean %>% 
  gather(colNames, weekday, 15:21) %>% 
  select(-colNames) %>% 
  na.omit(cols='weekday')

# create exact attendance date
program2021.clean <- program2021.clean %>% 
  mutate(AttendenceRealDate = case_when(
    weekday == "Monday" ~ AttendanceWeekDate,
    weekday == "Tuesday" ~ AttendanceWeekDate+1,
    weekday == "Wednesday" ~ AttendanceWeekDate+2,
    weekday == "Thursday" ~ AttendanceWeekDate+3,
    weekday == "Friday" ~ AttendanceWeekDate+4,
    weekday == "Saturday" ~ AttendanceWeekDate+5,
    weekday == "Sunday" ~ AttendanceWeekDate+6,
  ))
```

Through above wrangling, we obtain the real attendance date for each event. (p.s. a program may have more than one events which links with different program schedualed ids)

```{r wrangle ppr land data}
propertyParent <- pprProperties %>% 
  filter(NESTED=="N")

propertyKid <- pprProperties %>% 
  filter(NESTED=="Y")


```

```{r join property and program data}
program2021.join <- left_join(program2021.clean, facilityID, by =c("FacilityID")) %>% 
  left_join(., pprProperties, by =c("PPR_Properties_ObjectID"="OBJECTID"))

# get the failed joining items
program2021.join.na <- program2021.join[is.na(program2021.join$PPR_Properties_ObjectID),]

# filter the failed joining items
program2021.join <- program2021.join %>% na.omit(PPR_Properties_ObjectID)
```

Through above wrangling, we link program data to their based properties.

#### SafeGraph Data

```{r join safegraph data}
# filter into philly
safeGraph <- patternAllMonth %>% 
  filter(city == "Philadelphia")

# join with POI and brand data
safeGraph <- safeGraph %>% 
  left_join(core_poi, by=c("placekey","parent_placekey","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands"),keep=FALSE) %>%
  left_join(brand_info, by=c("safegraph_brand_ids"="safegraph_brand_id","brands"="brand_name","top_category","sub_category","naics_code"),keep=FALSE)

# create geometry from lat & lng
safeGraph.geo <- 
  safeGraph %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant", na.fail=FALSE) %>% st_transform(crs = crs)
```

```{r filter safegraph data}
## set future running stratege
library(furrr)
# change workers number by yourself
plan(multiprocess, workers = 10)


# keep congeneric bussiness
congenericMoves <-
  safeGraph.geo %>%
  filter(top_category %in% c("Promoters of Performing Arts, Sports, and Similar Events",
                             "Other Amusement and Recreation Industries",
                             "Museums, Historical Sites, and Similar Institutions") | str_detect(location_name, "Park") | str_detect(location_name, "Playground") | str_detect(location_name, "Recreation Center")) %>%
  filter(str_detect(location_name, "Parking", negate = TRUE))


# Keep only ppr sites
#712190:Nature Parks and Other Similar Institutions; 
#713990:All Other Amusement and Recreation Industries; 
#713940: Fitness and Recreational Sports Centers； 
#711310：Promoters of Performing Arts, Sports, and Similar Events
parks <- safeGraph.geo %>% 
  dplyr::select(placekey, naics_code, location_name) %>% 
  distinct() %>% 
  filter(naics_code %in% c(712190, 713990, 713940, 711310) | str_detect(location_name, "Park") | str_detect(location_name, "Playground") | str_detect(location_name, "Recreation Center")) %>%
  filter(str_detect(location_name, "Parking", negate = TRUE))

PPRmoves <- safeGraph.geo %>% 
  filter(placekey %in% as.list(parks$placekey))

#st_write(PPRmoves,"data/output/PPRmoves.GeoJSON")
PPRmoves <- st_read("data/output/PPRmoves.GeoJSON")

# spatial join with ppr sites - to be continued

# we need ask instructors which data to model, but for now just take PPRmoves

```

```{r Explore efficiency of filtering}
# join filtered safeGraph place with ppr property
property_safe_join <- st_join(property, parks %>% dplyr::select(placekey, geometry), left=FALSE)

# count
print(paste0("The number of PPR properties is ", n_distinct(property$PPR.Site.Name)))

print(paste0("The number joined properties is ", n_distinct(property_safe_join$PPR.Site.Name)))

# the filtering quality is okay at this point, more data will be added
```

```{r unnest safegraph data}
#This following code to unnest the pupularity_by_hout data is different from the above code. Because the pprMoves is read into the R, which directly delete the '['']'

# unnest visit Count data
# visitCount <-
#   PPRmoves %>%
#   select(placekey, date_range_start, date_range_end, visits_by_day) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          date_range_end = as_date(date_range_end)) %>%
#   dplyr::select(-date_range_end) %>%
#   mutate(visits_by_day = future_map(visits_by_day, function(x){
#     unlist(x) %>%
#       as_tibble() %>%
#       rowid_to_column(var = "day") %>%
#       mutate(visits = value) %>%
#       dplyr::select(-value)
#   })) %>%
#   unnest(cols = c("visits_by_day"))
# 
# st_write(visitCount,"data/output/visitCount.GeoJSON")
visitCount <- st_read("data/output/visitCount.GeoJSON")

# unnest popularity_by_hour data
visitHour <-
  PPRmoves %>%
  select(placekey, popularity_by_hour, date_range_start) %>%
  mutate(date_range_start = as_date(date_range_start),
         month =  month(date_range_start)) %>%
  dplyr::select(-date_range_start) %>%
  mutate(popularity_by_hour = future_map(popularity_by_hour, function(x){
    unlist(x) %>%
      as_tibble() %>%
      rowid_to_column(var = "hour") %>%
      rename(visit = value)
  }))%>%
  unnest(popularity_by_hour)
#  
#st_write(visitHour,"data/output/visitHour.GeoJSON")
visitHour <- st_read("data/output/visitHour.GeoJSON")


# unnest the origin-destination data

# originCount <-
#   PPRmoves %>%
#   select(placekey, visitor_home_cbgs, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble()
#   })) %>%
#   unnest(visitor_home_cbgs)
# 
# originCount <- originCount %>%
#   dplyr::select(placekey, month, starts_with("4")) %>%
#   pivot_longer(cols = starts_with("4"), names_to = "origin", values_to = "visits", values_drop_na = TRUE)

#st_write(originCount,"data/output/originCount.GeoJSON")
originCount <- st_read("data/output/originCount.GeoJSON")


# The following codes is different from the above. Because I try to gather the data inside the tibble instead of the old way. This new way can greatly increase the efficiency.

# unnest the departure - destination data
# departCount <-
#   PPRmoves %>%
#   select(placekey, visitor_daytime_cbgs, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(visitor_daytime_cbgs = future_map(visitor_daytime_cbgs, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>% 
#       dplyr::select(starts_with("4")) %>% 
#       gather()
#   }))%>%
#   unnest(visitor_daytime_cbgs) %>% 
#   rename(departure =key ,visitors= value)

#st_write(departCount,"data/output/departCount.GeoJSON")
departCount <- st_read("data/output/departCount.GeoJSON")

# unnest the bucketed_dwell_times data
# dwellTime <-
#   PPRmoves %>%
#   select(placekey, bucketed_dwell_times, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(bucketed_dwell_times = future_map(bucketed_dwell_times, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>%
#       gather()
#   }))%>%
#   unnest(bucketed_dwell_times) %>%
#   rename(dwellTimes =key ,visitors= value)

#st_write(dwellTime,"data/output/dwellTime.GeoJSON")
dwellTime <- st_read("data/output/dwellTime.GeoJSON")


# unnest the related_same_day_brand
# relatedBrand <-
#   PPRmoves %>%
#   select(placekey, related_same_day_brand, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(related_same_day_brand = future_map(related_same_day_brand, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>%
#       gather()
#   }))
# 
# relatedBrand <- relatedBrand %>%
#   unnest(related_same_day_brand) %>%
#   rename(relatedBrand =key ,visitors= value)

#st_write(relatedBrand,"data/output/relatedBrand.GeoJSON")
relatedBrand <- st_read("data/output/relatedBrand.GeoJSON")


# unnest the popularity_by_day data
# visitWeekday <-
#   PPRmoves %>%
#   select(placekey, popularity_by_day, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(popularity_by_day = future_map(popularity_by_day, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>%
#       gather()
#   }))%>%
#   unnest(popularity_by_day) %>%
#   rename(visitWeekday =key ,visits= value)
# 
# st_write(visitWeekday,"data/output/visitWeekday.GeoJSON")
visitWeekday <- st_read("data/output/visitWeekday.GeoJSON")
```

```{r left join the place information to the unnested data}
visitCount <- visitCount %>%
    rename(visitDay = date_range_start) %>% 
    mutate(visitDay = day+visitDay-1) %>% 
    mutate(month = month(visitDay))

# Problem: should the na geometry be dropped?
# join the location name of 'parks' into the unnested data
# visitCount2 <- visitCount %>% 
#   left_join(parks %>% st_drop_geometry() ,by=c('placekey' = 'placekey'))
# 
# test <- parks %>% 
#   mutate(count=1) %>% 
#   group_by(placekey) %>% 
#   mutate(location_name = location_name,count=sum(count)) %>% 
#   filter(count == 2)

```

### EXPLORATORY -- CENSUS DATA

## 1. Get each of the Philadelphia PPR zones
```{r census-exploration-1}

ggplot() + 
  geom_sf(data=ll(st_union(pprDistrict)),color="black",size=2,fill = "transparent",inherit.aes = FALSE)+
  geom_sf(data=ll(pprDistrict),color=palette1_main,size=2,fill = "transparent",inherit.aes = FALSE)+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```
## 2. Get the list of PHL census tracts that intersect with each zone
```{r getCensusTracts}

acs_vars <- c("B25026_001E","B02001_002E","B15001_050E",
                         "B15001_009E","B19013_001E","B25058_001E",
                         "B06012_002E", "B01001_048E", "B01001_049E",
                         "B01001_024E", "B01001_025E", "B07013_002E")

tracts19 <-
    get_acs(geography = "tract", 
            variables = acs_vars, 
            year=2019,
            state='PA', 
            county='Philadelphia',
            geometry=T, 
            output="wide") %>%
        st_transform(crs) %>%
        dplyr::rename(TotalPop = B25026_001E,
               White = B02001_002E,
               MedianHouseholdIncome = B19013_001E,
               MedianRent = B25058_001E,
               Poverty = B06012_002E,
               HousingUnits = B07013_002E) %>%
        dplyr::select(-NAME, -starts_with("B")) %>%
        mutate(pctNonWhite = ifelse(TotalPop < White, 0, ifelse(TotalPop > 0, 1 -(White / TotalPop),0)),
               pctPoverty = ifelse(TotalPop > 0, Poverty / TotalPop, 0))

## joined
tracts19_pprArea <- tracts19 %>%
                    st_join(pprDistrict, join=st_intersects)

tracts19_grouped_summary <- tracts19_pprArea %>%
      dplyr::select(TotalPop, MedianHouseholdIncome, MedianRent, HousingUnits, pctNonWhite, pctPoverty, DISTRICTID, geometry) %>%
      dplyr::group_by(DISTRICTID) %>%
      summarize(TotalPop_sum= sum(TotalPop),
                MedianHouseholdIncome_mean = mean(MedianHouseholdIncome, na.rm=TRUE),
                MedianRent_mean = mean(MedianRent, na.rm=TRUE),
                HousingUnits_sum = sum(HousingUnits, na.rm=TRUE),
                pctNonWhite_mean = mean(pctNonWhite),
                pctPoverty_mean = mean(pctPoverty)
      )

```
## 3. Get the average income for the census tracts within a zone

## 4. Create map that shows average income for each zone =  highlight zones 7-9

## 4. Repeat with other census variables







```{r}
# ggplot(PPRmoves)+
#   geom_line(aes(x = date_range_start, y = raw_visit_counts))+
#   facet_wrap(~location_name, scales = "free")
```

### Loading Data into Database

```{r load data into database}
library(RPostgres)

conn <- dbConnect(Postgres(), dbname = dbname, host = host, port = port, 
                  user = username, password = password)


# to lowercase and replace invalid character with "_"
s <- tracts19_grouped_summary %>%
  rename_all(tolower) %>%
  rename_all({function (t) str_replace_all(t,"[^\\w]","_")})

st_write(obj = s, dsn = conn, Id(table = "census_summary"))
# writing to postgres
# dbListTables(conn)
```

```{r load pprTrails data into database}
# print(pprTrails)
```

```{r load data into database}
```


### EXPLORATORY -- SafeGrpah DATA

```{r visit Count}
sumVisit <- visitCount %>%
  dplyr::select(-visitDay,-day,-month) %>% 
  group_by(placekey) %>%
  summarise(visits=sum(visits))

ggplot(sumVisit)+
  geom_sf(data=pprServiceArea,color='black',size=0.25,fill= "transparent")+
  geom_sf(data=pprServiceArea %>% filter(PPR_DIST %in% c(7,8,9)),color='black',size=0.5,fill= "transparent")+
  geom_sf(aes(size = visits),color = palette1_main,fill = palette1_main,alpha = 0.3) +
  mapTheme()
```
The above is the aggragated visits map of PPR sities. The data is from safegraph.

```{r origine Count, eval=FALSE, include=FALSE}

# the codes below are wrong, should add census geometry data into the dataframe 
sumVisit <- originCount %>%
  filter(!st_is_empty(.)) %>% 
  dplyr::select(-placekey,-month) %>% 
  group_by(origin) %>%
  summarise(visits=sum(visits))

sumVisit2 <- sumVisit %>% filter(!st_is_empty(.))

ggplot(sumVisit)+
  geom_sf(data=pprServiceArea,color='black',size=0.25,fill= "transparent")+
  geom_sf(data=pprServiceArea %>% filter(PPR_DIST %in% c(7,8,9)),color='black',size=0.5,fill= "transparent")+
  geom_sf(aes(size = visits),color = palette1_main,fill = palette1_main,alpha = 0.3) +
  mapTheme()
```

```{r temperal pattern by month}
sumVisit <- visitCount %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  dplyr::select(-visitDay,-day) %>% 
  group_by(month) %>%
  summarise(visits=sum(visits)) %>% 
  st_drop_geometry()

sumVisit%>%
  ggplot(aes(month,visits)) +
  geom_bar(position ="dodge",fill = palette1_main,stat='identity') +
  labs(x="Month", y="Aggregated Visits",
       title ='Zeihler Playground') +
  plotTheme(10,20)

```

```{r temperal pattern by day}
visitCount %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  st_drop_geometry()%>%
  na.omit()%>%
  ggplot(aes(visitDay,visits)) + 
  geom_line(color=palette1_main,size=1)+
  labs(title = 'Zeihler Playground',x="Visit Date",y="Safegraph Visit")+
  plotTheme(10,20)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

```

```{r temperal pattern by hour}
sumVisit <- visitHour %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  dplyr::select(-month) %>% 
  group_by(hour) %>%
  summarise(visits=sum(visit)) %>% 
  st_drop_geometry()

sumVisit%>%
  ggplot(aes(hour,visits)) +
  geom_bar(position ="dodge",fill = palette1_main,stat='identity') +
  labs(x="hour", y="Aggregated Visits",
       title ='Zeihler Playground') +
  plotTheme(10,20)
```

```{r temperal pattern by weekday}
sumVisit <- visitWeekday %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  dplyr::select(-month) %>% 
  group_by(visitWeekday) %>%
  summarise(visits=sum(visits)) %>% 
  st_drop_geometry() 

sumVisit$visitWeekday <- factor(sumVisit$visitWeekday, levels= c("Monday", 
    "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday","Sunday"))

sumVisit[order(sumVisit$visitWeekday), ]

sumVisit%>%
  ggplot(aes(visitWeekday,visits)) +
  geom_bar(position ="dodge",fill = palette1_main,stat='identity') +
  labs(x="Weekday", y="Aggregated Visits",
       title ='Zeihler Playground') +
  plotTheme(10,20)
```


```{r dwell time}
sumVisit <- dwellTime %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  dplyr::select(-month) %>% 
  group_by(dwellTimes) %>%
  summarise(visitors=sum(visitors)) %>% 
  st_drop_geometry() 

sumVisit$dwellTimes <- factor(sumVisit$dwellTimes, levels= c("<5",">240","11-20","121-240","21-60","5-10","61-120" ))

sumVisit[order(sumVisit$dwellTimes), ]

sumVisit%>%
  ggplot(aes(dwellTimes,visitors)) +
  geom_bar(position ="dodge",fill = palette1_main,stat='identity') +
  labs(x="Dwell Time", y="Aggregated Visitors",
       title ='Zeihler Playground') +
  plotTheme(10,20)
```

