---
title: "PPPR"
author: "PPPR Team"
output:
  html_document: 
    toc: yes
    toc_depth: 4
    toc_float: yes
    code_folding: hide
    theme: paper
  pdf_document: default
---

```{=html}
<style>
p.caption {
  font-size: 0.8em;
  text-align: center;
  font-weight: normal;
}
    caption {
      color: grey;
      font-size: 0.8em;
    }
@font-face{
  font-family: Helvetica; 
  src:url('Helvetica.ttf');
}
body{
  font-size: 11pt;
  font-family: Helvetica;
}
h1,h2,h3,h4,h5,h6{
  font-family: Helvetica;
}
td{
  font-size: 9pt;
  font-family: Helvetica;
}
th{
  font-size: 0.8em;
  font-family: Helvetica;
  color: black;
}
</style>
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, message=FALSE, warning=FALSE, results='hide'}
library(vroom)
library(sf)
library(ggplot2)
library(ggmap)
library(kableExtra)
library(tidyverse)
library(data.table)
#remotes::install_github("CityOfPhiladelphia/rphl")
library(rphl)
library(lubridate)
library(furrr)
library(tidycensus)
library(rgdal)
library(furrr)
library(mapview)
ll <- function(dat, proj4 = 4326){st_transform(dat, proj4)}

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

#windowsFonts(font = windowsFont('Helvetica'))

crs = 'EPSG:2272'

plotTheme <- function(base_size = 9, title_size = 10){
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = title_size, colour = "black", hjust = 0.5), 
    plot.subtitle = element_text( face = 'italic',
                                 size = base_size, colour = "black", hjust = 0.5),
    plot.caption = element_text( hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.01),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=.5),
    strip.background = element_blank(),
    strip.text = element_text( size=9),
    axis.title = element_text( size=9),
    axis.text = element_text( size=7),
    axis.text.y = element_text( size=7),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text( colour = "black", face = "italic", size = 9),
    legend.text = element_text( colour = "black", face = "italic", size = 7),
    strip.text.x = element_text( size = 9),
    legend.key.size = unit(.5, 'line')
  )
}

mapTheme <- function(base_size = 9, title_size = 10){
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = title_size, colour = "black", hjust = 0.5), 
    plot.subtitle = element_text( face = 'italic',
                                 size = base_size, colour = "black", hjust = 0.5),
    plot.caption = element_text( hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(size=base_size),
    axis.title = element_text( size=9),
    axis.text = element_blank(),
    axis.text.y = element_blank(),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text( colour = "black", face = "italic", size = 9),
    legend.text = element_text( colour = "black", face = "italic", size = 7),
    strip.text.x = element_text(size=base_size),
    legend.key.size = unit(.5, 'line')
  )
}

palette5 <- c("#f9b294","#f2727f","#c06c86","#6d5c7e","#315d7f")
palette4 <- c("#f9b294","#f2727f","#c06c86","#6d5c7e")
palette2 <- c("#f9b294","#f2727f")
palette1_main <- "#F2727F"
palette1_assist <- '#F9B294'
```


```{r loadSecrets, message=FALSE, warning=FALSE, results='hide'}

## NOTE: You will need to create secrets.json, using the template
## to enter private credentials for interacting with the database

get_secrets <- function() {
  path <- "secrets/secrets.json"
  if (!file.exists(path)) {
    stop("Can't find secret file: '", path, "'")
  }
  
  jsonlite::read_json(path)
}
#secrets <- get_secrets()

# database settings
# dbname = secrets$db_name
# host = secrets$db_host
# port = secrets$db_port
# username =  secrets$db_username
# password = secrets$db_password
# census_api_key(secrets$census_api_key, install=TRUE, overwrite=TRUE)
```

### Data Loading

#### Folder: SafeGraph

```{r brand_info, message=FALSE, warning=FALSE, include=FALSE}
brand_info <- vroom("data/safegraph/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-CORE_POI-2021_11-2021-12-17/brand_info.csv")
#colnames(brand_info)

# kable(head(brand_info,3),align = 'c',caption = '<center>Table 1. brand_info of SafeGraph data <center/>')%>%
#   kable_classic(full_width = F)%>%
#   kable_styling(position = "center")%>% 
#   scroll_box(width = "100%", height = "400px")
```

```{r core_poi, message=FALSE, warning=FALSE, include=FALSE}
core_poi <- vroom("data/safegraph/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-CORE_POI-2021_11-2021-12-17/core_poi.csv")
#colnames(core_poi)

# kable(head(core_poi,3),align = 'c',caption = '<center>Table 2. core_poi of SafeGraph data <center/>')%>%
#   kable_classic(full_width = F)%>%
#   kable_styling(position = "center")%>% 
#   scroll_box(width = "100%", height = "400px")
```

**These two datasets ('brand_info' and 'core_poi' from safegraph) are dictionary data.**

```{r wholeRawSG, message=FALSE, warning=FALSE,eval=FALSE}
#HPS = home_panel_summary
#NS = normalization_stats
#VPS = visit_panel_summary

monthList = c("01","02","03","04","05","06","07","08","09","10","11")

# home_panel_summary
hpsAllMonth = data.frame()

for (i in monthList){
  currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
       i,
       "-2021-12-17/home_panel_summary.csv",sep = ""))%>%
    filter(region=="pa")
  hpsAllMonth = rbind(hpsAllMonth,currentMonth)
  #print(paste("Current input home_panel_summary dataframe is in ",i," month",sep = ""))
}

# kable(head(hpsAllMonth,3),align = 'c',caption = '<center>Table 3. home pannel summary of 2021 whole year in SafeGraph data <center/>')%>%
#   kable_classic(full_width = F)%>%
#   kable_styling(position = "center")%>% 
#   scroll_box(width = "100%", height = "400px")

# normalization_Stats
nsAllMonth = data.frame()

for (i in monthList){
  currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
       i,
       "-2021-12-17/normalization_stats.csv",sep = ""))%>%
    filter(region=="pa")
  nsAllMonth = rbind(nsAllMonth,currentMonth)
  #print(paste("Current input normalization_stats dataframe is in ",i," month",sep = ""))
}

# kable(head(nsAllMonth,3),align = 'c',caption = '<center>Table 4. normalization stats of 2021 whole year in SafeGraph data <center/>')%>%
#   kable_classic(full_width = F)%>%
#   kable_styling(position = "center")%>% 
#   scroll_box(width = "100%", height = "400px")

# visit_panel_summary
vpsAllMonth = data.frame()

for (i in monthList){
  currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
       i,
       "-2021-12-17/visit_panel_summary.csv",sep = ""))%>%
    filter(region=="pa")
  vpsAllMonth = rbind(vpsAllMonth,currentMonth)
  #print(paste("Current input visit_panel_summary dataframe is in ",i," month",sep = ""))
}

# kable(head(vpsAllMonth,3),align = 'c',caption = '<center>Table 5. visit panel summary of 2021 whole year in SafeGraph data <center/>')%>%
#   kable_classic(full_width = F)%>%
#   kable_styling(position = "center")%>% 
#   scroll_box(width = "100%", height = "400px")

# Pattern
patternAllMonth = data.frame()

for (i in monthList){
  currentMonth = vroom(paste("data/safegraph/SafeGraph Data Purchase Dec-16-2021/Philadelphia-Camden-WilmingtonPA-NJ-DE-MDMSA-PATTERNS-2021_",
       i,
       "-2021-12-17/patterns.csv.gz",sep = ""))%>%
    filter(region=="PA")%>%
    mutate(month=paste(i,sep = ""))
  patternAllMonth = rbind(patternAllMonth,currentMonth)
  #print(paste("Current input patterns dataframe is in ",i," month",sep = ""))
}

# kable(head(patternAllMonth,3),align = 'c',caption = '<center>Table 6. patterns of 2021 whole year in SafeGraph data <center/>')%>%
#   kable_classic(full_width = F)%>%
#   kable_styling(position = "center")%>% 
#   scroll_box(width = "100%", height = "400px")
```

```{r readBackupData warning=FALSE,message=FALSE,include=FALSE}
# st_write(hpsAllMonth,"data/output/hpsAllMonth.csv")
# st_write(vpsAllMonth,"data/output/vpsAllMonth.csv")
# st_write(patternAllMonth,"data/output/patternAllMonth.csv")
# hpsAllMonth <- st_read("data/output/hpsAllMonth.csv")
# vpsAllMonth <- st_read("data/output/vpsAllMonth.csv")
patternAllMonth <- st_read("data/output/patternAllMonth.csv")
```

**This is the whole safegraph raw data**, it has four datasets. One is the aggregated pattern data for 2021 whole year. That is the primary one for this project. And the other two datasets give information about the number of active devices.

#### Folder: OpenDataPhilly

**Relevant data of PPR finder**

```{r openDataPhilly_pprDistrict,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 1. Locations of pprDistrict'}
philly <- st_read("https://opendata.arcgis.com/datasets/405ec3da942d4e20869d4e1449a2be48_0.geojson")

pprDistrict <- st_read('https://opendata.arcgis.com/datasets/0cdc4a1e86c6463b9600f9d9fca39875_0.geojson') %>%
  st_transform(crs)

destDistrict <- pprDistrict %>% filter(DISTRICTID %in% c(7,8,9))

base_map <- get_map(location = unname(st_bbox(ll(st_buffer(st_union(pprDistrict),11000)))),maptype = "terrian")

ggmap(base_map) + 
  geom_sf(data=ll(st_union(pprDistrict)),color="black",size=2,fill = "transparent",inherit.aes = FALSE)+
  geom_sf(data=ll(pprDistrict),color='black',size=2,fill = "transparent",inherit.aes = FALSE)+
  geom_sf(data=ll(destDistrict),color=palette1_main,size=2,fill = "transparent",inherit.aes = FALSE)+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```

The whole Philadelphia is divided into 10 PPR districts, and the project mainly focus on the District 7、8、9 as pilot project which are highlighted in the map using the color red. Note: The 9 district does not include the Smith Area.

```{r openDataPhilly_pprProperty,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 2. Locations of pprProperties'}
pprProperties <- st_read('https://opendata.arcgis.com/datasets/d52445160ab14380a673e5849203eb64_0.geojson')%>%
  st_transform(crs)

ggplot() + 
  geom_sf(data=pprProperties,color=palette1_main,fill = palette1_main)+
  geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
  geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```

```{r openDataPhilly_pprTrail, eval=FALSE, fig.align='center', fig.cap=, fig.height=5, message=FALSE, warning=FALSE, include=FALSE, out.width='75%', results='hide'}
pprTrails <- st_read('https://opendata.arcgis.com/datasets/48323d574068405bbf5336b9b5b29455_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprTrails,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_Out of school time programs, eval=FALSE, fig.align='center', fig.cap=, fig.height=5, message=FALSE, warning=FALSE, include=FALSE, out.width='75%', results='hide'}
pprOutPrograms <- st_read('https://opendata.arcgis.com/datasets/1f5d8108e06d457783538d4b7808c246_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprOutPrograms,color=palette1_main,size=8,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprPicnicSites,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 5. Locations of pprPicnicSites'}
pprPicnicSites <- st_read('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+ppr_picnic_sites&filename=ppr_picnic_sites&format=geojson&skipfields=cartodb_id')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprPicnicSites,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprAdultExercise,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 6. Locations of pprAdultExercise'}
pprAdExercise <- st_read('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+ppr_adult_exercise_equipment&filename=ppr_adult_exercise_equipment&format=geojson&skipfields=cartodb_id')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprAdExercise,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprSwimmingPool,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 7. Locations of pprSwimmingPool'}
pprSwimmingPool <- st_read('https://opendata.arcgis.com/datasets/c6f6176968f04d3f88adbc4c362af55d_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprSwimmingPool,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprTennisCourt,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 8. Locations of pprTennisCourt'}
pprTennisCourt <- st_read('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+ppr_tennis_courts&filename=ppr_tennis_courts&format=geojson&skipfields=cartodb_id')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprTennisCourt,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprSpraygrounds,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 9. Locations of pprSpraygrounds'}
pprSpraygrounds <- st_read('https://opendata.arcgis.com/datasets/a148cc904d374b22bd456e44a044d554_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprSpraygrounds,color=palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprHydrationStations,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 10. Locations of pprHydrationStations'}
pprHydrationStations <- st_read('https://opendata.arcgis.com/datasets/cc35dc98180249fb9a6f2f5f06657df1_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprHydrationStations,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprPlaygrounds,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 11. Locations of pprPlaygrounds'}
pprPlaygrounds <- st_read('https://opendata.arcgis.com/datasets/899c807e205244278b3f39421be8489c_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprPlaygrounds,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprBoatLaunches,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 12. Locations of pprBoatLaunches'}
pprBoatLaunches <- st_read('https://opendata.arcgis.com/api/v3/datasets/ba32e1ac9c5341e1916274c2df3fbe22_0/downloads/data?format=geojson&spatialRefId=4326')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprBoatLaunches,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprBuildingStructures,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 13. Locations of pprBuildingStructures'}
pprBuildingStructures <- st_read('https://opendata.arcgis.com/datasets/97e90a049a35453ba0c51f974b3c77b4_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprBuildingStructures,color=palette1_main,size=1,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprTreeCanopy,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 14. Locations of pprTreeCanopy'}
query <- paste("SELECT objectid, avg_height, shape_area",
               "FROM ppr_tree_canopy_outlines_2015",
               "ORDER BY objectid ASC")

pprTreeCanopyWithArea <- get_carto(query, format = "csv",
  base_url = "https://phl.carto.com/api/v2/sql", stringsAsFactors = F)


pprTreeCanopy <- st_read('https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+ppr_tree_canopy_points_2015&filename=ppr_tree_canopy_points_2015&format=geojson&skipfields=cartodb_id')%>%
  st_transform(crs)%>%
  left_join(pprTreeCanopyWithArea,by = "objectid")

# ggplot() + 
#   geom_sf(data=pprTreeCanopy,color=palette1_main,aes(size=shape_area),fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

```{r openDataPhilly_pprPermittableSpace,include=FALSE,  eval=FALSE,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure 15. Locations of pprPermittableSpace'}
pprPermittableSpace <- st_read('https://opendata.arcgis.com/datasets/811b67c999bd4e839abb68b16c16f623_0.geojson')%>%
  st_transform(crs)

# ggplot() + 
#   geom_sf(data=pprPermittableSpace,color=palette1_main,fill = palette1_main)+
#   geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
#   geom_sf(data=pprDistrict,color="black",size=1,linetype ="dashed",fill = "transparent")+
#   labs(title = "", 
#        subtitle = "",
#        x="",y="")+
#   mapTheme()
```

And there are other datasets from the PPR finder unused right now. They are datasets about the types, number and quality of facilities of PPR.

#### Folder: FromPPR

These are datasets directly from PPR officers. These datasets are highly related to our project.

```{r fromPPR_ServiceArea,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width ='75%',fig.align = 'center',fig.cap = 'Figure 15. Locations of pprServiceArea'}
pprServiceArea <- read_sf(dsn="data/FromPPR/PPR_Service_Areas_2021/PPR_Service_Areas_2021.shp")%>%
  st_transform(crs = crs)

pprDestServiceArea <- pprServiceArea %>% filter(PPR_DIST %in% c(7,8,9))

ggplot() + 
  geom_sf(data=pprServiceArea,color='black',size=1,fill = "transparent")+
  geom_sf(data=pprDestServiceArea,color=palette1_main,size=2,fill = "transparent")+
  geom_sf(data=st_union(pprDistrict),color="black",size=2,fill = "transparent")+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```

The above map is about service areas. Each district unit is divided into several service area units for the sake of administration. The pink lines in the map are the services areas in District 7,8,9. These service areas are the target of this project.

```{r fromPPR-recreation-permits-2021, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
perimit2021 <- vroom("data/FromPPR/PPR-recreation-permits-2021.csv")
# kable(head(perimit2021,3),align = 'c',caption = '<center>Table 7. Program information of PPR Recreation data <center/>')%>%
#   kable_classic(full_width = F)%>%
#   kable_styling(position = "center")%>% 
#   scroll_box(width = "100%", height = "400px")
```

```{r fromPPR-programs-attended-2021, warning=FALSE, message=FALSE}
program2021 <- vroom("data/FromPPR/PPR-programs-attended-2021-with-schedules.csv")
kable(head(program2021,3),align = 'c',caption = '<center>Table 8. Program information of PPR Programs data <center/>')%>%
  kable_classic(full_width = F)%>%
  kable_styling(position = "center")%>% 
  scroll_box(width = "100%", height = "460px")
```

The above dataset gives information about PPR programs in 2021, including information like the duration of the program, the attendence of the program etc. But some wrangling are needed for further uses. And the wrangling is taken in the next section.

```{r from Service_Area_Sites, eval=FALSE, include=FALSE}

propertyArea <- read.csv("data/FromPPR/Service_Area_Sites.csv") 
#The above dataset has information about each property inside the service area. This dataset is useless because it doesn't have geometry data.
```

```{r from tblFacility_to_PPR_Properties}
facilityID <- read.csv("data/FromPPR/tblFacility_to_PPR_Properties.csv")
```

The above dataset is offered as dictionary data to provide links between facility id and PPR property object id. ({003695FA-5CC6-4572-9916-799609577319} - 209). Right now the dataset only contains 7,8,9 districts. The others will be offered at the end of the Feburary.

### Data Wrangling

#### Property data

```{r join property data}
# # replace "and" with "&"
# pprProperties <- pprProperties %>% 
#   mutate(OFFICIAL_NAME = gsub("and", "&", pprProperties$OFFICIAL_NAME),
#          PUBLIC_NAME = gsub("and", "&", pprProperties$PUBLIC_NAME))
# 
# 
# # join method 1
# property.join1 <- left_join(propertyArea, 
#                           pprProperties %>% dplyr::select(ADDRESS_911, geometry), 
#                           by=c("X911.Address"="ADDRESS_911"), left=FALSE) %>% 
#   filter(!st_is_empty(geometry))
# 
# # join method 2
# property.join2 <- left_join(propertyArea, 
#                           pprProperties %>% dplyr::select(OFFICIAL_NAME, geometry), 
#                           by=c("PPR.Site.Name"="OFFICIAL_NAME"), left=FALSE) %>% 
#   filter(!st_is_empty(geometry))
# 
# # join method 3
# property.join3 <- left_join(propertyArea, 
#                           pprProperties %>% dplyr::select(PUBLIC_NAME, geometry), 
#                           by=c("PPR.Site.Name"="PUBLIC_NAME"), left=FALSE) %>% 
#   filter(!st_is_empty(geometry))
# 
# # combine 3 methods together
# property <- rbind(property.join1,property.join2) %>% 
#   rbind(property.join3,.) %>% 
#   distinct() %>% 
#   st_sf()
# 
# x <- left_join(propertyArea, property, by="PPR.Site.Name") %>% 
#   filter(st_is_empty(geometry))


# According to the email, we should directly use pprProperties to spatial join the service area to get the service area information. Therefore, the above code should be delete.


property <- st_join(st_centroid(pprProperties),pprServiceArea,left=TRUE) %>% 
  st_drop_geometry() %>% 
  left_join(pprProperties %>% dplyr::select(OBJECTID,geometry),by='OBJECTID') %>% 
  st_sf() %>% 
  st_transform(crs = 4326) %>% 
  dplyr::select(-Shape__Length,-Shape__Area,-Shape_Leng,-Shape_Area) %>% 
  rename('ServiceAreaID' = 'INFO')

```

```{r properties in the service area,fig.height = 5,message = FALSE, warning = FALSE, results='hide',out.width = '75%',fig.align = 'center',fig.cap = 'Figure. Locations of properties in District 7,8,9'}
# map the location of properties in district 7,8,9
ggplot() + 
  geom_sf(data=property %>% filter(PPR_DIST %in% c(7,8,9)),color=palette1_main,fill = palette1_main)+
  geom_sf(data=st_union(pprDestServiceArea %>% filter(PPR_DIST ==7)),color="black",size=2,fill = "transparent")+
  geom_sf(data=st_union(pprDestServiceArea %>% filter(PPR_DIST ==8)),color="black",size=2,fill = "transparent")+
  geom_sf(data=st_union(pprDestServiceArea %>% filter(PPR_DIST ==9)),color="black",size=2,fill = "transparent")+
  geom_sf(data=pprDestServiceArea,color="black",size=0.75,linetype ="dashed",fill = "transparent")+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```

Through above wrangling, we obtain the newest data about property and link them with service areas. The map only map the properties in the district 7/8/9

#### Program data

```{r wrangle program data, eval=FALSE, message=FALSE, warning=FALSE}
# define date 
program2021.clean <- program2021 %>% 
  mutate(AttendanceWeekDate = mdy(AttendanceWeekDate),
         DateFrom = mdy(DateFrom),
         DateTo = mdy(DateTo))

# create a df only containing records without program scheduel info
program2021.NA <- program2021.clean[is.na(program2021.clean$ProgramScheduleID),]

# filter by attendance date
program2021.clean <- program2021.clean %>% 
  filter(AttendanceWeekDate > DateFrom & AttendanceWeekDate < DateTo)

# original data is recorded by week, here we change it into being recorded by occurence
program2021.clean <- separate(program2021.clean, Days,into= c("1","2","3","4","5","6","7"))

program2021.clean <- program2021.clean %>% 
  gather(colNames, weekday, 15:21) %>% 
  select(-colNames) %>% 
  na.omit(cols='weekday')

# create exact attendance date
program2021.clean <- program2021.clean %>% 
  mutate(AttendenceRealDate = case_when(
    weekday == "Monday" ~ AttendanceWeekDate,
    weekday == "Tuesday" ~ AttendanceWeekDate+1,
    weekday == "Wednesday" ~ AttendanceWeekDate+2,
    weekday == "Thursday" ~ AttendanceWeekDate+3,
    weekday == "Friday" ~ AttendanceWeekDate+4,
    weekday == "Saturday" ~ AttendanceWeekDate+5,
    weekday == "Sunday" ~ AttendanceWeekDate+6,
  ))
```

```{r readBackup Program2021.clean, message=FALSE,warning=FALSE,include=FALSE}
#st_write(program2021.clean,"data/output/program2021.clean.csv")
# st_write(program2021.join.na,"data/output/program2021.join.na.csv")
# st_write(program2021.join,"data/output/program2021.join.csv")

program2021.clean <- st_read("data/output/program2021.clean.csv")
program2021.join.na <- st_read("data/output/program2021.join.na.csv")
program2021.join <- st_read("data/output/program2021.join.csv")
```

Through above wrangling, we obtain the real attendance date for each event. (p.s. a program may have more than one events which links with different program schedualed ids)

```{r join property and program data, eval=FALSE}
program2021.join <- left_join(program2021.clean, facilityID, by =c("FacilityID" = "FacilityID")) %>% 
  left_join(., property, by =c("PPR_Properties_ObjectID"="OBJECTID"))

# get the failed joining items
program2021.join.na <- program2021.join[is.na(program2021.join$PPR_Properties_ObjectID),]

# filter the failed joining items
program2021.join <- program2021.join %>% drop_na(PPR_Properties_ObjectID)
```

Through above wrangling, we link program data to their based properties,their belonged Service Area.

#### SafeGraph Data

```{r join safegraph data,warning=FALSE,message=FALSE,eval}
# filter into philly
safeGraph <- patternAllMonth %>% 
  filter(city == "Philadelphia")

# join with POI and brand data
safeGraph <- safeGraph %>%
  left_join(core_poi %>% dplyr::select(placekey,location_name,top_category,sub_category,naics_code,latitude,longitude),
            by=c("placekey"="placekey","location_name" = "location_name"),keep=FALSE)
# safeGraph <- safeGraph %>%
#   left_join(core_poi, by=c("placekey","parent_placekey","location_name","street_address","city","region","postal_code","safegraph_brand_ids","brands"),keep=FALSE) %>%
#   left_join(brand_info, by=c("safegraph_brand_ids"="safegraph_brand_id","brands"="brand_name","top_category","sub_category","naics_code"),keep=FALSE)

# create geometry from lat & lng
safeGraph.geo <- 
  safeGraph %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326, agr = "constant", na.fail=FALSE)
```

```{r readBackupSafeGraph, include=FALSE,warning=FALSE,message=FALSE}
#st_write(safeGraph.geo,"data/output/safeGraph.geo.GeoJSON")
safeGraph.geo <- st_read("data/output/safeGraph.geo.GeoJSON",crs = 4326)
#st_write(PPRmoves,"data/output/PPRmoves.GeoJSON")
PPRmoves <- st_read("data/output/PPRmoves.GeoJSON",crs=4326)
```

```{r filter safegraph data, message=FALSE, warning=FALSE,eval=FALSE}
# change workers number by yourself
plan(multiprocess, workers = 10)


# keep congeneric bussiness
congenericMoves <-
  safeGraph.geo %>%
  filter(top_category %in% c("Promoters of Performing Arts, Sports, and Similar Events",
                             "Other Amusement and Recreation Industries",
                             "Museums, Historical Sites, and Similar Institutions") | str_detect(location_name, "Park") | str_detect(location_name, "Playground") | str_detect(location_name, "Recreation Center")) %>%
  filter(str_detect(location_name, "Parking", negate = TRUE))


# Keep only ppr sites
#712190:Nature Parks and Other Similar Institutions; 
#713990:All Other Amusement and Recreation Industries; 
#713940: Fitness and Recreational Sports Centers； 
#711310：Promoters of Performing Arts, Sports, and Similar Events
parks <- safeGraph.geo %>% 
  dplyr::select(placekey, naics_code, location_name) %>% 
  distinct() %>% 
  filter(naics_code %in% c(712190, 713990, 713940, 711310) | str_detect(location_name, "Park") | str_detect(location_name, "Playground") | str_detect(location_name, "Recreation Center")) %>%
  filter(str_detect(location_name, "Parking", negate = TRUE)) %>% 
  st_transform(crs = 4326)

PPRmoves <- safeGraph.geo %>% 
  filter(placekey %in% as.list(parks$placekey))

# join filtered safeGraph place with ppr property

propertyWithPlaceKey <- st_join(property %>% st_buffer(10),parks %>% dplyr::select(placekey, geometry),left=FALSE) %>%
  st_drop_geometry() %>% 
  left_join(property %>% dplyr::select(OBJECTID),by=('OBJECTID'='OBJECTID')) %>% 
  st_sf() %>% 
  st_transform(crs=4326) %>% 
  drop_na(placekey)

# count
print(paste0("The number of PPR properties is ", n_distinct(property$PUBLIC_NAME),"The number joined properties is ", n_distinct(propertyWithPlaceKey$PUBLIC_NAME)))


```

```{r display the join outcome, warning=FALSE,message=FALSE,include=FALSE}
# the filtering quality is okay at this point, more data will be added
mapview(property)+mapview(st_centroid(propertyWithPlaceKey),col.regions = "green")
```
In the above map, the polygon is the properties of PPR, the green dots are the successfully join properties with placekey

```{r update program2021.joinWith with placekey,eval=FALSE}
program2021.joinWithPlaceKey <- 
  st_join(program2021.join %>%
            st_sf() %>% 
            st_transform(crs=4326) %>%
            st_buffer(10),
          parks %>% dplyr::select(placekey, geometry),left=FALSE) %>%
  st_drop_geometry() %>%  
  merge.data.frame(program2021.join %>%
                     dplyr::select(geometry),
                   by='row.names')%>%
  dplyr::select(-Row.names) %>% 
  st_sf() %>% 
  st_transform(crs=4326)

mapview(property)+mapview(program2021.joinWithPlaceKey,col.regions = "red")
```

```{r readBackupprogram2021.joinWithPlaceKey,warning=FALSE,message=FALSE}
#st_write(program2021.joinWithPlaceKey,"data/output/program2021.joinWithPlaceKey.GeoJSON")
program2021.joinWithPlaceKey <- st_read("data/output/program2021.joinWithPlaceKey.GeoJSON",crs=4326)
```

```{r unnest safegraph data,warning=FALSE,message=FALSE}
#This following code to unnest the pupularity_by_hout data is different from the above code. Because the pprMoves is read into the R, which directly delete the '['']'

# unnest visit Count data
# visitCount <-
#   PPRmoves %>%
#   select(placekey, date_range_start, date_range_end, visits_by_day) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          date_range_end = as_date(date_range_end)) %>%
#   dplyr::select(-date_range_end) %>%
#   mutate(visits_by_day = future_map(visits_by_day, function(x){
#     unlist(x) %>%
#       as_tibble() %>%
#       rowid_to_column(var = "day") %>%
#       mutate(visits = value) %>%
#       dplyr::select(-value)
#   })) %>%
#   unnest(cols = c("visits_by_day"))
# visitCount <- visitCount %>%
#     rename(visitDay = date_range_start) %>% 
#     mutate(visitDay = day+visitDay-1) %>% 
#     mutate(month = month(visitDay))
# st_write(visitCount,"data/output/visitCount.GeoJSON")
visitCount <- st_read("data/output/visitCount.GeoJSON",crs=4326)

# unnest popularity_by_hour data
# visitHour <-
#   PPRmoves %>%
#   select(placekey, popularity_by_hour, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(popularity_by_hour = future_map(popularity_by_hour, function(x){
#     unlist(x) %>%
#       as_tibble() %>%
#       rowid_to_column(var = "hour") %>%
#       rename(visit = value)
#   }))%>%
#   unnest(popularity_by_hour)
# 
# st_write(visitHour,"data/output/visitHour.GeoJSON")
visitHour <- st_read("data/output/visitHour.GeoJSON",crs=4326)


# unnest the origin-destination data

# originCount <-
#   PPRmoves %>%
#   select(placekey, visitor_home_cbgs, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(visitor_home_cbgs = future_map(visitor_home_cbgs, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>% 
#       dplyr::select(starts_with("4")) %>%
#       gather()
#   })) %>%
#   unnest(visitor_home_cbgs) %>% 
#   rename(origin =key ,visitors= value)
# 
# st_write(originCount,"data/output/originCount.GeoJSON")
originCount <- st_read("data/output/originCount.GeoJSON",crs=4326)


#unnest the departure - destination data
# departCount <-
#   PPRmoves %>%
#   select(placekey, visitor_daytime_cbgs, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(visitor_daytime_cbgs = future_map(visitor_daytime_cbgs, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>%
#       dplyr::select(starts_with("4")) %>%
#       gather()
#   }))%>%
#   unnest(visitor_daytime_cbgs) %>%
#   rename(departure =key ,visitors= value)
# 
# st_write(departCount,"data/output/departCount.GeoJSON")
departCount <- st_read("data/output/departCount.GeoJSON",crs=4326)

# unnest the bucketed_dwell_times data
# dwellTime <-
#   PPRmoves %>%
#   select(placekey, bucketed_dwell_times, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(bucketed_dwell_times = future_map(bucketed_dwell_times, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>%
#       gather()
#   }))%>%
#   unnest(bucketed_dwell_times) %>%
#   rename(dwellTimes =key ,visitors= value)
# 
# st_write(dwellTime,"data/output/dwellTime.GeoJSON")
dwellTime <- st_read("data/output/dwellTime.GeoJSON",crs=4326)


# unnest the related_same_day_brand
# relatedBrand <-
#   PPRmoves %>%
#   select(placekey, related_same_day_brand, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(related_same_day_brand = future_map(related_same_day_brand, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>%
#       gather()
#   }))
# 
# relatedBrand <- relatedBrand %>%
#   unnest(related_same_day_brand) %>%
#   rename(relatedBrand =key ,visitors= value)
# 
# st_write(relatedBrand,"data/output/relatedBrand.GeoJSON")
relatedBrand <- st_read("data/output/relatedBrand.GeoJSON",crs=4326)


# unnest the popularity_by_day data
# visitWeekday <-
#   PPRmoves %>%
#   select(placekey, popularity_by_day, date_range_start) %>%
#   mutate(date_range_start = as_date(date_range_start),
#          month =  month(date_range_start)) %>%
#   dplyr::select(-date_range_start) %>%
#   mutate(popularity_by_day = future_map(popularity_by_day, function(x){
#     jsonlite::fromJSON(x) %>%
#       as_tibble() %>%
#       gather()
#   }))%>%
#   unnest(popularity_by_day) %>%
#   rename(visitWeekday =key ,visits= value)
# 
# st_write(visitWeekday,"data/output/visitWeekday.GeoJSON")
visitWeekday <- st_read("data/output/visitWeekday.GeoJSON",crs=4326)
```


### EXPLORATORY -- CENSUS DATA

#### 1. Get each of the Philadelphia PPR zones
```{r census-exploration-1}

ggplot() + 
  geom_sf(data=ll(st_union(pprDistrict)),color="black",size=2,fill = "transparent",inherit.aes = FALSE)+
  geom_sf(data=ll(pprDistrict),color=palette1_main,size=2,fill = "transparent",inherit.aes = FALSE)+
  labs(title = "", 
       subtitle = "",
       x="",y="")+
  mapTheme()
```
#### 2. Get the list of PHL census tracts that intersect with each zone
```{r getCensusTracts}

acs_vars <- c("B25026_001E","B02001_002E","B15001_050E",
                         "B15001_009E","B19013_001E","B25058_001E",
                         "B06012_002E", "B01001_048E", "B01001_049E",
                         "B01001_024E", "B01001_025E", "B07013_002E")


blocks19 <-
    get_acs(geography = "block group", 
            variables = acs_vars, 
            year=2019,
            state='PA', 
            county='Philadelphia',
            geometry=T, 
            output="wide") %>%
        st_transform(crs) %>%
        dplyr::rename(TotalPop = B25026_001E,
               White = B02001_002E,
               MedianHouseholdIncome = B19013_001E,
               MedianRent = B25058_001E,
               Poverty = B06012_002E,
               HousingUnits = B07013_002E) %>%
        dplyr::select(-NAME, -starts_with("B")) %>%
        mutate(pctNonWhite = ifelse(TotalPop < White, 0, ifelse(TotalPop > 0, 1 -(White / TotalPop),0)),
               pctPoverty = ifelse(TotalPop > 0, Poverty / TotalPop, 0))

## joined
blocks19_pprArea <- blocks19 %>%
                    st_join(pprDistrict, join=st_intersects)

blocks19_summary <- blocks19_pprArea %>%
      dplyr::select(GEOID, TotalPop, MedianHouseholdIncome, MedianRent, HousingUnits, pctNonWhite, pctPoverty, DISTRICTID, Shape__Area, Shape__Length, geometry)

blocks19_grouped_summary <- blocks19_pprArea %>%
        dplyr::select(TotalPop, MedianHouseholdIncome, MedianRent, HousingUnits, pctNonWhite, pctPoverty, DISTRICTID, geometry) %>%
      dplyr::group_by(DISTRICTID) %>%
      summarize(TotalPop_sum= sum(TotalPop),
                MedianHouseholdIncome_mean = mean(MedianHouseholdIncome, na.rm=TRUE),
                MedianRent_mean = mean(MedianRent, na.rm=TRUE),
                HousingUnits_sum = sum(HousingUnits, na.rm=TRUE),
                pctNonWhite_mean = mean(pctNonWhite),
                pctPoverty_mean = mean(pctPoverty)
      )

```


```{r}
# ggplot(PPRmoves)+
#   geom_line(aes(x = date_range_start, y = raw_visit_counts))+
#   facet_wrap(~location_name, scales = "free")
```

#### Loading Data into Database

```{r load data into database}
library(RPostgres)

df_to_db <- function(conn, df, table_name) {
  s <- df %>%
    rename_all(tolower) %>%
    rename_all({function (t) str_replace_all(t,"[^\\w]","_")})
  st_write(obj = s, dsn = conn, Id(table = table_name))
}
conn <- dbConnect(Postgres(), dbname = dbname, host = host, port = port, 
                  user = username, password = password)

df_to_db(conn, blocks19_summary, "census_block_groups")
# writing to postgres
# dbListTables(conn)
```

```{r load pprTrails data into database}
# print(pprTrails)
```

```{r load data into database}
```


### EXPLORATORY -- SafeGrpah DATA

```{r visit Count,fig.height = 5,message = FALSE, warning = FALSE,out.width ='75%',fig.align = 'center',fig.cap = 'Figure. Map of total visits'}
sumVisit <- visitCount %>%
  dplyr::select(-visitDay,-day,-month) %>% 
  group_by(placekey) %>%
  summarise(visits=sum(visits))

ggplot(sumVisit)+
  geom_sf(data=pprServiceArea,
          color='black',
          size=0.25,
          fill= "transparent")+
  geom_sf(data=pprServiceArea %>% filter(PPR_DIST %in% c(7,8,9)),
          color='black',
          size=0.5,
          fill= "transparent")+
  geom_sf(aes(size = visits),
          color = palette1_main,
          fill = palette1_main,
          alpha = 0.3) +
  scale_size_continuous(range = c(5, 15),
                        name = "Visits")+
  mapTheme()+
  theme(legend.position = "bottom",
        legend.key.width = unit(1.5, 'cm'),
        legend.key.height  = unit(1.2, 'cm'))
```

The above is the aggragated visits map of PPR sities. The data is from safegraph.

```{r origine Count plot preparation, include=FALSE}
census_api_key("b33ec1cb4da108659efd12b3c15412988646cbd8", overwrite = TRUE)
CensusData <- 
  get_acs(geography = "block group", 
          variables = c("B01003_001E"), 
          year=2019, state="PA", county="Philadelphia", geometry=T, output="wide") %>%
  st_transform(crs=4326) %>% 
  dplyr::select(-NAME,-starts_with('B')) %>% 
  st_centroid() %>% 
  as.data.frame() %>% 
  rename("originGeometry" = "geometry")

placekeyGeometry <- 
  originCount %>% 
  dplyr::select(placekey) %>% 
  group_by(placekey) %>% summarise()


orgCountPlot <- originCount %>% 
  st_drop_geometry() %>% 
  group_by(origin,placekey) %>%
  summarise(visitors=sum(visitors))%>% 
  left_join(placekeyGeometry,by=c("placekey" = "placekey")) %>% 
  rename("parkGeometry" = "geometry")%>%
  filter(startsWith(origin,"42101"))%>%
  left_join(CensusData,by=c("origin" = "GEOID"))%>%
  mutate(park.y=as.numeric(map(parkGeometry,function(x){return(x[2])})),
         park.x=as.numeric(map(parkGeometry,function(x){return(x[1])})),
         origin.y=as.numeric(map(originGeometry,function(x){return(x[2])})),
         origin.x=as.numeric(map(originGeometry,function(x){return(x[1])})))

orgCountPlot2 <- orgCountPlot%>%
  filter(visitors>200)

orgCountPlotHF <- orgCountPlot%>%
  filter(visitors>2000)
```

```{r fig.height = 5,message = FALSE, warning = FALSE,out.width ='75%',fig.align = 'center',fig.cap = 'Figure. Flow map of parks and origins'}
ggplot(data = orgCountPlot2) + 
  geom_sf(data = pprServiceArea %>% st_transform(crs=4326),fill ="transparent", color="black",size=1)+
  geom_sf(data=pprDistrict %>% st_transform(crs=4326),fill ="transparent", color="black",size=2)+
  geom_curve(aes(x = origin.x, 
                 y = origin.y, 
                 xend = park.x, 
                 yend = park.y,
                 color = q5(visitors)),
             size = 1.5,
             curvature = -0.2, 
             alpha = 0.4,
             arrow = arrow(length = unit(0.01, "npc")))+
  scale_color_manual(values = palette5,
                     labels = qBr(orgCountPlot2,"visitors"),
                     name = "Visitors (Quintile Breaks)") +
  labs(x="",y="")+
  mapTheme()+
  theme(legend.position = "bottom",panel.spacing = unit(6, 'lines'),
        legend.key.width = unit(1.5, 'cm'),
        legend.key.height  = unit(1.2, 'cm'))
```

```{r fig.height = 5,message = FALSE, warning = FALSE,out.width ='75%',fig.align = 'center',fig.cap = 'Figure. Flow map of parks and origins - High Frequency'}
ggplot(data = orgCountPlotHF) + 
  geom_sf(data = pprServiceArea %>% st_transform(crs=4326),fill ="transparent", color="black",size=1)+
  geom_sf(data=pprDistrict %>% st_transform(crs=4326),fill ="transparent", color="black",size=2)+
  geom_curve(aes(x = origin.x, 
                 y = origin.y, 
                 xend = park.x, 
                 yend = park.y),
             size = 2.5,
             color = palette1_main,
             curvature = -0.2, 
             alpha = 0.4,
             arrow = arrow(length = unit(0.01, "npc")))+
  labs(x="",y="")+
  mapTheme()+
  theme(legend.position = "bottom",panel.spacing = unit(6, 'lines'),
        legend.key.width = unit(1.5, 'cm'),
        legend.key.height  = unit(1.2, 'cm'))
```

```{r Departure Count plot preparation, include=FALSE}
depaCountPlot <- departCount %>% 
  st_drop_geometry() %>% 
  group_by(departure,placekey) %>%
  summarise(visitors=sum(visitors))%>% 
  left_join(placekeyGeometry,by=c("placekey" = "placekey")) %>% 
  rename("parkGeometry" = "geometry")%>%
  filter(startsWith(departure,"42101"))%>%
  left_join(CensusData,by=c("departure" = "GEOID"))%>%
  mutate(park.y=as.numeric(map(parkGeometry,function(x){return(x[2])})),
         park.x=as.numeric(map(parkGeometry,function(x){return(x[1])})),
         departure.y=as.numeric(map(originGeometry,function(x){return(x[2])})),
         departure.x=as.numeric(map(originGeometry,function(x){return(x[1])})))

depaCountPlot2 <- depaCountPlot%>%
  filter(visitors>200)

depaCountPlotHF <- depaCountPlot%>%
  filter(visitors>2000)
```

```{r fig.height = 5,message = FALSE, warning = FALSE,out.width ='75%',fig.align = 'center',fig.cap = 'Figure. Flow map of parks and departure points'}
ggplot(data = depaCountPlot2) + 
  geom_sf(data = pprServiceArea %>% st_transform(crs=4326),fill ="transparent", color="black",size=1)+
  geom_sf(data=pprDistrict %>% st_transform(crs=4326),fill ="transparent", color="black",size=2)+
  geom_curve(aes(x = departure.x, 
                 y = departure.y, 
                 xend = park.x, 
                 yend = park.y,
                 color = q5(visitors)),
             size = 1.5,
             curvature = -0.2, 
             alpha = 0.4,
             arrow = arrow(length = unit(0.01, "npc")))+
  scale_color_manual(values = palette5,
                     labels = qBr(depaCountPlot2,"visitors"),
                     name = "Visitors (Quintile Breaks)") +
  labs(x="",y="")+
  mapTheme()+
  theme(legend.position = "bottom",panel.spacing = unit(6, 'lines'),
        legend.key.width = unit(1.5, 'cm'),
        legend.key.height  = unit(1.2, 'cm'))
```

```{r fig.height = 5,message = FALSE, warning = FALSE,out.width ='75%',fig.align = 'center',fig.cap = 'Figure. Flow map of parks and departure - High Frequency'}
ggplot(data = depaCountPlotHF) + 
  geom_sf(data = pprServiceArea %>% st_transform(crs=4326),fill ="transparent", color="black",size=1)+
  geom_sf(data=pprDistrict %>% st_transform(crs=4326),fill ="transparent", color="black",size=2)+
  geom_curve(aes(x = departure.x, 
                 y = departure.y, 
                 xend = park.x, 
                 yend = park.y),
             size = 2.5,
             color = palette1_main,
             curvature = -0.2, 
             alpha = 0.4,
             arrow = arrow(length = unit(0.01, "npc")))+
  labs(x="",y="")+
  mapTheme()+
  theme(legend.position = "bottom",panel.spacing = unit(6, 'lines'),
        legend.key.width = unit(1.5, 'cm'),
        legend.key.height  = unit(1.2, 'cm'))
```


```{r dwell time ,fig.height = 5,message = FALSE, warning = FALSE,out.width ='75%',fig.align = 'center',fig.cap = 'Figure. Map of dwell time'}
dwellTimeForPlot <- dwellTime %>% 
  mutate(dwellTimes = recode(dwellTimes,
                             "<5" = 2.5,
                             "5-10" = 7.5,
                             "11-20" = 15,
                             "21-60" = 40,
                             "61-120" = 90,
                             "121-240" = 180,
                             ">240" = 0)) %>%
  mutate(sepTotalDwellTime = (visitors*dwellTimes)) %>% 
  group_by(placekey) %>% 
  mutate(totalVisitors=sum(visitors) )%>%
  mutate(avgDwellTime=sum(sepTotalDwellTime)/totalVisitors) %>% 
  dplyr::select(placekey,avgDwellTime) %>% 
  distinct()

ggplot(dwellTimeForPlot)+
  geom_sf(data=pprServiceArea,
          color='black',
          size=0.25,
          fill= "transparent")+
  geom_sf(data=pprDistrict,
          color='black',
          size=0.75,
          fill='transparent')+
  geom_sf(aes(size = avgDwellTime,
              color = avgDwellTime),
          alpha = 0.5) +
  scale_size_continuous(range = c(1, 6),
                        name = "avgDwellTime")+
  scale_color_continuous(low = '#FFDEDB',high ='#FF2903',
                     name = "avgDwellTime") +
  mapTheme()+
  theme(legend.position = "bottom",
        legend.key.width = unit(1.5, 'cm'),
        legend.key.height  = unit(1.2, 'cm'))
```
From the above plot we can see the largest dwelling time is at Matthias Baldwin Park(zzz-223@628-pgb-hh5) with avgerage dwelling time is 133.

```{r dwell time ,fig.height = 5,message = FALSE, warning = FALSE,out.width ='75%',fig.align = 'center',fig.cap = 'Figure. Map of dwell time'}
sumVisit <- dwellTime %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  dplyr::select(-month) %>% 
  group_by(dwellTimes) %>%
  summarise(visitors=sum(visitors)) %>% 
  st_drop_geometry() 

sumVisit$dwellTimes <- factor(sumVisit$dwellTimes, levels= c("<5",">240","11-20","121-240","21-60","5-10","61-120" ))

sumVisit[order(sumVisit$dwellTimes), ]

sumVisit%>%
  ggplot(aes(dwellTimes,visitors)) +
  geom_bar(position ="dodge",fill = palette1_main,stat='identity') +
  labs(x="Dwell Time", y="Aggregated Visitors",
       title ='Zeihler Playground') +
  plotTheme(10,20)
```


```{r temperal pattern by month}
sumVisit <- visitCount %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  dplyr::select(-visitDay,-day) %>% 
  group_by(month) %>%
  summarise(visits=sum(visits)) %>% 
  st_drop_geometry()

sumVisit%>%
  ggplot(aes(month,visits)) +
  geom_bar(position ="dodge",fill = palette1_main,stat='identity') +
  labs(x="Month", y="Aggregated Visits",
       title ='Zeihler Playground') +
  plotTheme(10,20)

```

```{r temperal pattern by day}
visitCount %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  st_drop_geometry()%>%
  na.omit()%>%
  ggplot(aes(visitDay,visits)) + 
  geom_line(color=palette1_main,size=1)+
  labs(title = 'Zeihler Playground',x="Visit Date",y="Safegraph Visit")+
  plotTheme(10,20)+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))

```

```{r temperal pattern by hour}
sumVisit <- visitHour %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  dplyr::select(-month) %>% 
  group_by(hour) %>%
  summarise(visits=sum(visit)) %>% 
  st_drop_geometry()

sumVisit%>%
  ggplot(aes(hour,visits)) +
  geom_bar(position ="dodge",fill = palette1_main,stat='identity') +
  labs(x="hour", y="Aggregated Visits",
       title ='Zeihler Playground') +
  plotTheme(10,20)
```

```{r temperal pattern by weekday}
sumVisit <- visitWeekday %>% 
  filter(placekey=='zzz-222@628-pj6-ndv') %>% 
  dplyr::select(-month) %>% 
  group_by(visitWeekday) %>%
  summarise(visits=sum(visits)) %>% 
  st_drop_geometry() 

sumVisit$visitWeekday <- factor(sumVisit$visitWeekday, levels= c("Monday", 
    "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday","Sunday"))

sumVisit[order(sumVisit$visitWeekday), ]

sumVisit%>%
  ggplot(aes(visitWeekday,visits)) +
  geom_bar(position ="dodge",fill = palette1_main,stat='identity') +
  labs(x="Weekday", y="Aggregated Visits",
       title ='Zeihler Playground') +
  plotTheme(10,20)
```


